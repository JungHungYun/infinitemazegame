<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite Maze Game</title>
    <!-- 캐시로 인한 버전 불일치(로그인/리더보드 오류) 완화: 브라우저 캐시를 최대한 억제 -->
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <!-- favicon.ico 404 방지(파비콘 파일이 없어도 요청이 나가지 않게) -->
    <link rel="icon" href="data:,">
    <link rel="stylesheet" href="style.css?v=20251227_16">
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <!-- 인게임 HUD (모바일/터치 접근성) -->
    <div id="hud" class="hud hidden" aria-hidden="true">
        <button id="hud-settings" class="hud-btn hud-settings" type="button" aria-label="설정">⚙</button>
        <button id="hud-missile" class="hud-btn hud-missile" type="button">미사일 발사</button>
    </div>

    <!-- 타이틀 화면: 시작 버튼 클릭 시 시작 -->
    <div id="title-screen" role="dialog" aria-modal="true">
        <div class="title-card">
            <button id="title-settings" class="title-settings-btn" type="button" aria-label="설정">⚙</button>
            <div class="title-name">INFINITE MAZE</div>
            <div class="title-sub">미로를 돌파하고, 추격자를 피해 올라가세요.</div>

            <div class="title-layout">
                <div class="title-left">
                    <div class="title-controls">
                        <div class="title-controls-title">조작법</div>
                        <div class="title-controls-grid">
                            <div class="k">마우스</div><div class="v">이동 방향</div>
                            <div class="k">X</div><div class="v">미사일 발사 (X / 하단 버튼)</div>
                            <div class="k">ESC</div><div class="v">설정</div>
                        </div>
                    </div>

                    <button id="title-start" class="btn btn-primary">시작</button>
                    <div class="title-hint">시작 버튼을 누른 뒤 오디오가 재생됩니다.</div>
                </div>

                <div class="title-right">
                    <div class="panel">
                        <div class="panel-title">로그인</div>
                        <div id="auth-status" class="panel-sub">로그인하면 점수가 리더보드에 기록됩니다.</div>

                        <form id="auth-form" class="auth-form">
                            <input id="auth-email" class="input" type="email" autocomplete="email" placeholder="이메일" required />
                            <input id="auth-password" class="input" type="password" autocomplete="current-password" placeholder="비밀번호" required />
                            <input id="auth-username" class="input" type="text" autocomplete="nickname" placeholder="닉네임(리더보드 표시용)" required />

                            <div class="auth-actions">
                                <button id="auth-signin" type="button" class="btn">로그인</button>
                                <button id="auth-signup" type="button" class="btn btn-secondary">회원가입</button>
                                <button id="auth-signout" type="button" class="btn hidden">로그아웃</button>
                            </div>
                        </form>
                        <div id="auth-msg" class="panel-hint"></div>
                    </div>

                    <div class="panel">
                        <div class="panel-title">리더보드 (TOP 10)</div>
                        <div class="panel-sub">최고 점수 순</div>
                        <div id="leaderboard" class="leaderboard">
                            <div class="lb-row muted">불러오는 중...</div>
                        </div>
                        <div id="leaderboard-msg" class="panel-hint"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 10층마다 표시되는 어빌리티 선택창 -->
    <div id="ability-modal" class="hidden" role="dialog" aria-modal="true">
        <div class="ability-card">
            <div class="ability-header">
                <div class="ability-title">어빌리티 선택</div>
                <div class="ability-sub">
                    <span class="ability-meta meta-coin"><span id="ability-coin-count">0</span></span>
                    <span class="ability-meta-sep">·</span>
                    <span class="ability-meta meta-floor"><span id="ability-floor">1</span>F</span>
                </div>
            </div>

            <div id="ability-choices" class="ability-choices"></div>

            <div id="ability-status" class="ability-status"></div>

            <div class="ability-actions">
                <button id="ability-reroll" class="btn">리롤 (<span id="ability-reroll-cost">1</span>)</button>
                <button id="ability-skip" class="btn btn-secondary">건너뛰기</button>
            </div>
        </div>
    </div>

    <!-- ESC 설정창 -->
    <div id="settings-modal" class="hidden" role="dialog" aria-modal="true">
        <div class="settings-card">
            <div class="settings-header">
                <div class="settings-title">설정</div>
                <button id="settings-close" class="btn btn-secondary">닫기 (Esc)</button>
            </div>

            <div class="settings-row">
                <div class="settings-label">효과음</div>
                <input id="settings-sfx" class="settings-slider" type="range" min="0" max="100" step="1" value="85">
                <div id="settings-sfx-val" class="settings-val">85%</div>
            </div>

            <div class="settings-row">
                <div class="settings-label">BGM</div>
                <input id="settings-bgm" class="settings-slider" type="range" min="0" max="100" step="1" value="35">
                <div id="settings-bgm-val" class="settings-val">35%</div>
            </div>

            <div id="settings-control-row" class="settings-row">
                <div class="settings-label">조작</div>
                <div class="settings-control">
                    <div class="segmented" role="group" aria-label="모바일 조작 방식">
                        <button id="settings-control-touch" class="seg-btn" type="button">터치</button>
                        <button id="settings-control-gyro" class="seg-btn" type="button">자이로</button>
                    </div>
                    <button id="settings-gyro-calibrate" class="btn btn-secondary" type="button">중립 설정</button>
                </div>
            </div>
            <div id="settings-control-msg" class="settings-sub"></div>

            <div class="settings-sub">첫 입력(키/클릭) 이후 오디오가 재생됩니다.</div>
        </div>
    </div>

    <!-- 게임 오버 화면 -->
    <div id="gameover-modal" class="hidden" role="dialog" aria-modal="true" aria-label="게임 오버">
        <div class="gameover-card">
            <div class="gameover-title">GAME OVER</div>
            <div class="gameover-sub">이번 런 요약</div>

            <div class="gameover-grid">
                <div class="k">최고 층</div><div class="v"><span id="gameover-floor">1</span>F</div>
                <div class="k">점수</div><div class="v"><span id="gameover-score">0</span></div>
                <div class="k">코인</div><div class="v"><span id="gameover-coins">0</span></div>
                <div class="k">생존 시간</div><div class="v"><span id="gameover-time">0:00</span></div>
                <div class="k">잡힘</div><div class="v"><span id="gameover-caught">0</span></div>
                <div class="k">보스 처치</div><div class="v"><span id="gameover-boss-kills">0</span></div>
            </div>

            <div class="gameover-actions">
                <button id="gameover-restart" class="btn btn-primary">메인으로</button>
            </div>
            <div class="gameover-hint">2초 후 메인으로 돌아갑니다. (Enter / R)</div>
        </div>
    </div>

    <!-- Service Worker: 캐시 꼬임 근본 완화(네트워크 우선 + 업데이트 감지) -->
    <script src="sw-register.js?v=20251227_12"></script>

    <!-- 캐시 강제 갱신을 위한 버전 파라미터 -->
    <script src="config.js?v=20251227_16"></script>
    <!-- Supabase: CDN(jsdelivr) 추적방지/스토리지 경고를 줄이기 위해 로컬 번들 사용 -->
    <script src="vendor/supabase.min.js?v=20251227_16"></script>
    <script src="supabaseClient.js?v=20251227_16"></script>
    <script src="ui_auth.js?v=20251227_16"></script>
    <script src="ui_leaderboard.js?v=20251227_16"></script>
    <script src="ui_gameover.js?v=20251227_16"></script>
    <script src="audio.js?v=20251227_16"></script>
    <script src="ui_settings.js?v=20251227_16"></script>
    <script src="ui_ability.js?v=20251227_16"></script>
    <script src="game.js?v=20251227_16"></script>
    <script>
        // 리더보드가 "불러오는 중..."에서 멈출 때 원인 파악용 안전장치
        // (ui_leaderboard.js가 404/문법 오류 등으로 로드 실패하면 여기서 메시지를 띄움)
        window.addEventListener('load', () => {
            const msgEl = document.getElementById('leaderboard-msg');
            if (typeof window.leaderboardRefresh === 'function') {
                // 혹시 초기 호출 타이밍 이슈가 있으면 한 번 더 호출
                window.leaderboardRefresh();
            } else if (msgEl) {
                msgEl.textContent = '리더보드 스크립트 로드 실패(파일 경로/캐시/배포 상태를 확인하세요).';
                msgEl.style.color = '#ff9aa2';
            }
        });
    </script>
</body>
</html>
